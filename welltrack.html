<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTrack Gesundheitstagebuch</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6750A4">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #F9DEDC;
            --md-sys-color-on-error-container: #410E0B;
            --md-sys-color-background: #FFFBFE;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-surface-container-highest: #E6E0E9;
            --md-sys-color-surface-container-low: #F7F2FA;
            --md-sys-color-warning: #FFC107;
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: bottom;
        }
        .card {
            background-color: var(--md-sys-color-surface-container-low);
            border: 1px solid var(--md-sys-color-surface-variant);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .fab {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 1.5rem;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px 3px rgba(0,0,0,.15), 0 1px 3px rgba(0,0,0,.3);
            transition: all 0.2s ease-in-out;
        }
        .fab:hover {
             box-shadow: 0 6px 12px 4px rgba(0,0,0,.15), 0 2px 4px rgba(0,0,0,.3);
             transform: translateY(-2px);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn:disabled {
            background-color: var(--md-sys-color-surface-variant) !important;
            color: var(--md-sys-color-on-surface-variant) !important;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-primary:hover:not(:disabled) { background-color: #5a4293; }
        .btn-secondary { background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
        .btn-tertiary { border: 1px solid var(--md-sys-color-outline); color: var(--md-sys-color-primary); }
        .btn-warning { background-color: var(--md-sys-color-warning); color: var(--md-sys-color-on-background); }
        .btn-error { background-color: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); }
        .btn-error:hover:not(:disabled) { background-color: #f8c8c6; }


        .day-btn.selected { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border-color: var(--md-sys-color-primary); }
        .view-toggle-btn.active { background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-color: var(--md-sys-color-primary-container); z-index: 10; }
        
        .body-part { fill: var(--md-sys-color-surface-container-highest); stroke: var(--md-sys-color-outline); stroke-width: 0.5; cursor: pointer; transition: fill 0.2s ease-in-out; }
        .body-part:hover { fill: var(--md-sys-color-primary-container); }
        .svg-label { font-size: 8px; font-family: 'Roboto', sans-serif; fill: var(--md-sys-color-on-surface-variant); pointer-events: none; text-anchor: middle; }
        
        .nav-btn {
            padding: 8px;
            border-radius: 99px;
            transition: all 0.2s;
        }
        .nav-btn.active {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }
        .nav-btn:not(.active):hover {
             background-color: var(--md-sys-color-surface-container-low);
        }
        
        /* Mood Slider Styles */
        .mood-slider-wrapper {
            position: relative;
            height: 40px; /* Increased height for easier clicking */
            cursor: pointer;
        }
        .mood-slider-ruler {
            position: absolute;
            height: 8px;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-image: linear-gradient(to right, #ef4444, #f97316, #fbbf24 49%, #bfdbfe 51%, #60a5fa, #22c55e);
            border-radius: 4px;
        }
        .mood-slider-tick-container {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 24px;
            width: calc(100% - 4px);
            left: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }
        .mood-slider-tick {
            width: 4px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
        }
        .mood-slider-default-indicator {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #facc15;
            display: none;
            z-index: 3;
            pointer-events: none;
        }
        input[type=range].mood-slider {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            position: relative;
            z-index: 2;
            margin: 0;
            height: 100%;
        }
        input[type=range].mood-slider.is-default + .mood-slider-default-indicator {
            display: inline-block;
        }
        input[type=range].mood-slider.is-default {
            pointer-events: none;
        }
        input[type=range].mood-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 32px;
            width: 32px;
            border-radius: 50%;
            background: var(--md-sys-color-primary);
            cursor: pointer;
            border: 5px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: opacity 0.2s ease-in-out;
        }
        input[type=range].mood-slider.is-default::-webkit-slider-thumb {
            opacity: 0;
            pointer-events: none;
        }

        input[type=range].mood-slider::-moz-range-thumb {
            height: 32px;
            width: 32px;
            border-radius: 50%;
            background: var(--md-sys-color-primary);
            cursor: pointer;
            border: 5px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: opacity 0.2s ease-in-out;
        }
        input[type=range].mood-slider.is-default::-moz-range-thumb {
            opacity: 0;
            pointer-events: none;
        }
        .history-tab-group .history-tab.active {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-color: var(--md-sys-color-primary-container);
            z-index: 10;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-gray-200">
        <div class="container mx-auto max-w-4xl px-4 py-3 flex justify-between items-center">
            <div id="header-left">
                <button id="nav-today" onclick="WellTrackApp.events.showPage('today')" class="nav-btn">
                    <span class="material-symbols-outlined text-3xl">home</span>
                </button>
            </div>
            <div id="header-right">
                 <nav id="main-nav" class="flex items-center gap-2">
                    <button id="nav-event" onclick="WellTrackApp.events.showPage('event')" class="nav-btn rounded-full" title="Ereignis eintragen">
                        <span class="material-symbols-outlined">checklist</span>
                    </button>
                     <button id="nav-mood" onclick="WellTrackApp.events.showPage('mood')" class="nav-btn rounded-full" title="Stimmung eintragen">
                        <span class="material-symbols-outlined">sentiment_satisfied</span>
                    </button>
                     <button id="nav-pain" onclick="WellTrackApp.events.showPage('pain')" class="nav-btn rounded-full" title="Schmerzen eintragen">
                        <span class="material-symbols-outlined">personal_injury</span>
                    </button>
                    <div class="border-l h-6 mx-2 border-gray-300"></div>
                    <button id="nav-history" onclick="WellTrackApp.events.showPage('history')" class="nav-btn rounded-full" title="Verlauf">
                        <span class="material-symbols-outlined">timeline</span>
                    </button>
                    <button id="nav-log" onclick="WellTrackApp.events.showPage('log')" class="nav-btn rounded-full" title="Protokoll">
                        <span class="material-symbols-outlined">history</span>
                    </button>
                    <button id="nav-settings" onclick="WellTrackApp.events.showPage('settings')" class="nav-btn rounded-full" title="Einstellungen">
                        <span class="material-symbols-outlined">settings</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="container mx-auto max-w-4xl p-4 md:p-6">
        <!-- Page content will be dynamically inserted here -->
    </main>
    
    <!-- Floating Action Button for Scroll to Top -->
    <div class="fixed bottom-6 right-6 z-10">
        <button id="scroll-to-top" onclick="WellTrackApp.utils.scrollToTop()" class="fab opacity-0 transform translate-y-4 transition-all duration-300">
            <span class="material-symbols-outlined">arrow_upward</span>
        </button>
    </div>

    <!-- Modal Structure -->
    <div id="modal-container" onclick="if (event.target === this) { WellTrackApp.render.modal.hide() }" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-3xl p-6 shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <!-- Modal content will be dynamically inserted here -->
        </div>
    </div>

<script>
// Main application object
const WellTrackApp = {
    // --- STATE ---
    // Holds the dynamic state of the application
    state: {
        activePage: 'today', // today, event, mood, pain, history, log, settings
        currentPainPart: null,
        charts: {}, // pain, event, mood will be dynamically populated
        currentPage: 1,
        currentEditingEvent: null,
        timeRange: 7,
        notificationPermission: Notification.permission,
        activeMoodGroup: 'arousal_level',
        activeEventGroup: null, // Set to null initially, will be set to first group on page load
        activeHistoryTab: 'event',
        isPainEntryStarted: false,
        isMoodEntryStarted: false,
        lastDataResetDay: null,
    },

    // --- CONFIGURATION ---
    // Static configuration and UI strings
    config: {
        ENTRIES_PER_PAGE: 10,
        DEFAULT_BODY_COLOR: '#E6E0E9',
        PAIN_LEVELS: {
            0: { label: "Kein Schmerz", short: "-", color: "#86efac" },
            1: { label: "Leicht", short: "L", color: "#bfdbfe" },
            2: { label: "Unangenehm", short: "U", color: "#fde047" },
            3: { label: "Stark", short: "S", color: "#fb923c" },
            4: { label: "Fürchterlich", short: "F", color: "#ef4444" },
            5: { label: "Vernichtend", short: "X", color: "#9333ea" },
        },
        DAY_NAMES: ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'],
        DAY_DISPLAY_ORDER: [
            { name: 'Mo', index: 1 }, { name: 'Di', index: 2 }, { name: 'Mi', index: 3 }, { name: 'Do', index: 4 },
            { name: 'Fr', index: 5 }, { name: 'Sa', index: 6 }, { name: 'So', index: 0 }
        ],
        CHART_FONT_OPTIONS: {
            font: { size: 12, weight: 'bold' }
        },
        DEFAULT_EVENTS_JSON: `[
            {"name": "Spaziergang", "activity": "walking", "days": [], "increment": 15, "unitType": "min", "groupType": "Bewegung"},
            {"name": "Kaffee Tassen", "activity": "coffee_cups", "days": [], "increment": 1, "unitType": "", "groupType": "Ernährung"},
            {"name": "Ibuprofen 400mg", "activity": "ibuprofen_400", "days": [], "increment": 0, "unitType": "Einnahme", "groupType": "Medikamente"},
            {"name": "Rückenübungen", "activity": "back_exercises", "days": [1, 2, 3, 4, 5], "increment": 15, "unitType": "min", "groupType": "Bewegung"}
        ]`,
        MOOD_GROUPS: {
            'arousal_level': {
                name: 'Energie & Motivation',
                questions: [
                    { id: 'energy', name: 'Energie', negative: 'Müde/Kraftlos', positive: 'Energiegeladen' },
                    { id: 'motivation', name: 'Motivation', negative: 'Lethargisch', positive: 'Motiviert' },
                    { id: 'inner_drive', name: 'Innere Unruhe', negative: 'Getrieben', positive: 'Zentriert' },
                    { id: 'temperament', name: 'Temperament', negative: 'Geladen/Gereizt', positive: 'Gelassen' },
                    { id: 'anxiety', name: 'Angstfreiheit', negative: 'Ängstlich', positive: 'Ruhig/Frei' },
                    { id: 'focus', name: 'Fokus', negative: 'Abgelenkt', positive: 'Fokussiert' }
                ]
            },
            'affective_state': {
                name: 'Stimmung & Selbstwert',
                questions: [
                    { id: 'happiness', name: 'Glücklichkeit', negative: 'Deprimiert', positive: 'Glücklich' },
                    { id: 'outlook', name: 'Ausblick/Hoffnung', negative: 'Hoffnungslos', positive: 'Hoffnungsvoll' },
                    { id: 'self_esteem', name: 'Selbstwert', negative: 'Wertlos', positive: 'Wertvoll' },
                    { id: 'stability', name: 'Stabilität', negative: 'Labil', positive: 'Stabil' },
                    { id: 'social_connection', name: 'Soziale Verbindung', negative: 'Zurückgezogen', positive: 'Engagiert' }
                ]
            }
        },
        MOOD_VALUE_MAP: [-3, -2, -1, 1, 2, 3]
    },

    // --- INITIALIZATION ---
    init() {
        document.addEventListener('DOMContentLoaded', () => {
            this.events.showPage(this.state.activePage);
            this.events.initEventListeners();
            this.events.registerServiceWorker();
            this.events.checkDayChange();
        });
    },

    // --- DATA MANAGEMENT ---
    data: {
        getExportableData() {
            // Summarize increment events before exporting
            const metrics = this.getMetrics();
            const summarizedMetrics = WellTrackApp.utils.summarizeMetricsForExport(metrics);
            return {
                metrics: summarizedMetrics,
                events: this.getEvents(),
                settings: {
                    reminderTime: localStorage.getItem('wellTrackReminderTime')
                }
            };
        },
        saveData() {
            // This function now persists the current state of metrics, events, and settings
            // into a single structure in localStorage, identical to the export format.
            const exportData = this.getExportableData();
            localStorage.setItem('wellTrackExportableData', JSON.stringify(exportData));
            
            // We store the raw, unsummarized metrics for live updates within the day
            // The summarization happens on load and for export.
            
            // Refresh UI components that depend on the data
            if (['today'].includes(WellTrackApp.state.activePage)) {
                 if(document.getElementById('todays-log-container')) WellTrackApp.render.todaysLog();
            } else if (WellTrackApp.state.activePage === 'history') {
                WellTrackApp.render.historyPage(); // Re-render the whole page to update all charts
            }
        },
        getMetrics() {
            return JSON.parse(localStorage.getItem('wellTrackMetrics')) || [];
        },
        saveMetrics(metrics) {
            localStorage.setItem('wellTrackMetrics', JSON.stringify(metrics));
            this.saveData(); // Trigger master save
        },
        getEvents() {
            const events = localStorage.getItem('wellTrackEvents');
            if (events) {
                // Ensure all events have a groupType
                return JSON.parse(events).map(e => ({ ...e, groupType: e.groupType || '' }));
            } else {
                const defaultEvents = JSON.parse(WellTrackApp.config.DEFAULT_EVENTS_JSON);
                this.saveEvents(defaultEvents);
                return defaultEvents;
            }
        },
        saveEvents(events) {
            localStorage.setItem('wellTrackEvents', JSON.stringify(events));
            this.saveData(); // Trigger master save
        },
        loadTodaysState() {
            const page = WellTrackApp.state.activePage;
            const today = new Date().toISOString().split('T')[0];

            if(WellTrackApp.state.lastDataResetDay !== today) {
                WellTrackApp.state.isMoodEntryStarted = false;
                WellTrackApp.state.isPainEntryStarted = false;
                WellTrackApp.state.lastDataResetDay = today;
            }

            if (page === 'pain') {
                const todaysPainMetrics = this.getMetrics().filter(e => e.metric.startsWith('pain_') && e.timestamp.startsWith(today));
                WellTrackApp.state.isPainEntryStarted = todaysPainMetrics.length > 0;
                
                const lastEntryTimeSpan = document.getElementById('pain-last-entry-time');
                if (lastEntryTimeSpan) {
                    if (todaysPainMetrics.length > 0) {
                        const lastEntry = todaysPainMetrics.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                        lastEntryTimeSpan.textContent = `(${new Date(lastEntry.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })})`;
                    } else {
                        lastEntryTimeSpan.textContent = '';
                    }
                }

                document.querySelectorAll('.body-part').forEach(part => {
                    const latestEntry = todaysPainMetrics.filter(m => m.labels.body_part === part.id).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                    if (latestEntry) {
                        part.style.fill = WellTrackApp.config.PAIN_LEVELS[latestEntry.value].color;
                        part.dataset.level = latestEntry.value;
                    } else {
                        part.style.fill = WellTrackApp.config.DEFAULT_BODY_COLOR;
                        delete part.dataset.level;
                    }
                });
                WellTrackApp.events.updateNewEntryButtonState();

            } else if (page === 'mood') {
                const todaysMoodMetrics = this.getMetrics().filter(e => e.metric.startsWith('mood_') && e.timestamp.startsWith(today));
                WellTrackApp.state.isMoodEntryStarted = todaysMoodMetrics.length > 0;

                const lastEntryTimeSpan = document.getElementById('mood-last-entry-time');
                if (lastEntryTimeSpan) {
                    if (todaysMoodMetrics.length > 0) {
                        const lastEntry = todaysMoodMetrics.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                        lastEntryTimeSpan.textContent = `(${new Date(lastEntry.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })})`;
                    } else {
                        lastEntryTimeSpan.textContent = '';
                    }
                }

                if (!WellTrackApp.state.activeMoodGroup) {
                    WellTrackApp.state.activeMoodGroup = 'arousal_level';
                }

                const activeGroup = WellTrackApp.config.MOOD_GROUPS[WellTrackApp.state.activeMoodGroup];
                if(activeGroup){
                    activeGroup.questions.forEach(q => {
                        const slider = document.getElementById(`mood-slider-${q.id}`);
                        if(slider){
                            const latestEntry = todaysMoodMetrics.filter(m => m.labels.mood_id === q.id).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                            const sliderValue = latestEntry ? WellTrackApp.config.MOOD_VALUE_MAP.indexOf(latestEntry.value) : -1;
                            
                            if (sliderValue !== -1) {
                                slider.value = sliderValue;
                                slider.classList.remove('is-default');
                            } else {
                                slider.value = 2.5; // Visually center it, but it's hidden
                                slider.classList.add('is-default');
                            }
                        }
                    });
                }
                WellTrackApp.events.updateNewEntryButtonState();
            }
        },
        exportData() {
            const dataToExport = this.getExportableData();
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `welltrack_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click(); URL.revokeObjectURL(url);
        },
        importData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    const eventsToImport = imported.events;
                    if (imported.metrics && eventsToImport) {
                         WellTrackApp.render.modal.showConfirmation('Daten importieren', 'Möchtest du die aktuellen Daten wirklich überschreiben? Diese Aktion kann nicht rückgängig gemacht werden.',
                            () => { 
                                this.saveMetrics(imported.metrics); 
                                this.saveEvents(eventsToImport); 
                                if(imported.settings && imported.settings.reminderTime) {
                                    localStorage.setItem('wellTrackReminderTime', imported.settings.reminderTime);
                                }
                                location.reload(); 
                            });
                    } else { WellTrackApp.render.modal.showAlert('Fehler', 'Die Importdatei hat ein ungültiges Format.'); }
                } catch (err) { WellTrackApp.render.modal.showAlert('Fehler', 'Die Datei konnte nicht gelesen werden.'); }
            };
            reader.readAsText(file); event.target.value = '';
        },
    },

    // --- UI RENDERING ---
    render: {
        todayPage() {
            const container = document.getElementById('app-container');
            container.innerHTML = this.components.todaySection();
            this.todaysLog();
        },
        eventPage() {
            const container = document.getElementById('app-container');
            container.innerHTML = this.components.eventSection();
            this.eventListByGroup(WellTrackApp.state.activeEventGroup);
        },
        moodPage() {
            const container = document.getElementById('app-container');
            container.innerHTML = this.components.moodSection();
            WellTrackApp.data.loadTodaysState();
        },
        painPage() {
            const container = document.getElementById('app-container');
            container.innerHTML = this.components.painSection();
            document.querySelectorAll('.body-part').forEach(part => part.addEventListener('click', (e) => WellTrackApp.events.handleBodyPartClick(e)));
            WellTrackApp.data.loadTodaysState();
        },
        settingsPage() {
            document.getElementById('app-container').innerHTML = this.components.settingsSection();
            this.manageEventList();
        },
        historyPage() {
            const container = document.getElementById('app-container');
            container.innerHTML = this.components.historySection();
             // Destroy all previous charts
            Object.values(WellTrackApp.state.charts).forEach(chart => {
                if(chart && typeof chart.destroy === 'function') chart.destroy();
            });
            WellTrackApp.state.charts = {}; // Reset chart state

            this.charts.renderAll();
            WellTrackApp.events.handleHistoryTabClick(WellTrackApp.state.activeHistoryTab, false);
        },
        fullLogPage(page = 1) {
            const container = document.getElementById('app-container');
            container.innerHTML = this.components.fullLogSection();
            
            WellTrackApp.state.currentPage = page;
            const logContainer = document.getElementById('log-entries-container');
            if (!logContainer) return;
            logContainer.innerHTML = '';
            const groupedData = {};
            
            WellTrackApp.data.getMetrics().forEach(metric => {
                const date = new Date(metric.timestamp).toLocaleDateString('de-DE');
                if (!groupedData[date]) groupedData[date] = [];
                groupedData[date].push(metric);
            });

            const sortedDates = Object.keys(groupedData).sort((a, b) => new Date(b.split('.').reverse().join('-')) - new Date(a.split('.').reverse().join('-')));
            if (sortedDates.length === 0) {
                logContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Noch keine Einträge vorhanden.</p>';
                document.getElementById('log-pagination').innerHTML = ''; return;
            }
            const startIndex = (page - 1) * WellTrackApp.config.ENTRIES_PER_PAGE;
            const endIndex = page * WellTrackApp.config.ENTRIES_PER_PAGE;
            const paginatedDates = sortedDates.slice(startIndex, endIndex);
            
            paginatedDates.forEach(date => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl border border-gray-200';
                const summarizedMetrics = WellTrackApp.utils.summarizeMetrics(groupedData[date]);
                div.innerHTML = this.components.logEntry(date, summarizedMetrics);
                logContainer.appendChild(div);
            });
            this.pagination(sortedDates.length);
        },
        eventListByGroup(groupType) {
            const eventContainer = document.getElementById('todays-event-container');
            if (!eventContainer) return;

            const todaysData = WellTrackApp.data.getMetrics();
            const todaysEventsDone = todaysData.filter(e => e.metric.startsWith('event_') && WellTrackApp.utils.isToday(new Date(e.timestamp)));
            
            let allEvents = WellTrackApp.data.getEvents();
            let filteredEvents;

            if (groupType === '*') {
                filteredEvents = allEvents.filter(event => !event.groupType);
            } else {
                filteredEvents = allEvents.filter(event => event.groupType === groupType);
            }

            const eventItems = filteredEvents.map(event => {
                const todaysEntries = todaysEventsDone.filter(t => t.labels.activity === event.activity);
                let value = 0;
                if (event.increment === 0) {
                    value = todaysEntries.length; // For timestamp events, value is the count
                } else {
                    value = todaysEntries.reduce((sum, entry) => sum + entry.value, 0);
                }
                return { data: event, value: value, entries: todaysEntries };
            });
            
            eventContainer.innerHTML = ''; // Clear previous items
            if(eventItems.length === 0){
                eventContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Keine Ereignisse in dieser Gruppe.</p>`;
                return;
            }

            eventItems.forEach(item => {
                const div = document.createElement('div');
                div.id = `event-item-${item.data.activity}`;
                div.className = `p-4 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-4 bg-gray-100`;
                if(item.data.increment === 0) {
                     div.innerHTML = WellTrackApp.render.components.eventItemTimestamp(item.data, item.value > 0, item.entries);
                } else {
                     div.innerHTML = WellTrackApp.render.components.eventItemIncrement(item.data, item.value);
                }
                eventContainer.appendChild(div);
            });
        },
        todaysLog(){
            const container = document.getElementById('todays-log-container');
            if (!container) return;

            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);

            const allData = WellTrackApp.data.getMetrics();
            let todaysMetrics = allData.filter(e => WellTrackApp.utils.isSameDay(new Date(e.timestamp), today));
            let yesterdaysMetrics = allData.filter(e => WellTrackApp.utils.isSameDay(new Date(e.timestamp), yesterday));
            
            // Summarize before calculating totals
            const summarizedToday = WellTrackApp.utils.summarizeMetrics(todaysMetrics);
            const summarizedYesterday = WellTrackApp.utils.summarizeMetrics(yesterdaysMetrics);

            // Calculate totals for today
            const todaysTotalPain = summarizedToday.filter(m => m.metric.startsWith('pain_')).reduce((sum, m) => sum + m.value, 0);
            const todaysTotalEvent = summarizedToday.filter(m => m.metric.startsWith('event_') && m.labels.unitType === 'min').reduce((sum, m) => sum + m.value, 0);
            const todaysTotalMood = summarizedToday.filter(m => m.metric.startsWith('mood_')).reduce((sum, m) => sum + m.value, 0);

            // Calculate totals for yesterday
            const yesterdaysTotalPain = summarizedYesterday.filter(m => m.metric.startsWith('pain_')).reduce((sum, m) => sum + m.value, 0);
            const yesterdaysTotalEvent = summarizedYesterday.filter(m => m.metric.startsWith('event_') && m.labels.unitType === 'min').reduce((sum, m) => sum + m.value, 0);
            const yesterdaysTotalMood = summarizedYesterday.filter(m => m.metric.startsWith('mood_')).reduce((sum, m) => sum + m.value, 0);

            // Generate comparison text
            const painDelta = todaysTotalPain - yesterdaysTotalPain;
            const eventDelta = todaysTotalEvent - yesterdaysTotalEvent;
            const moodDelta = todaysTotalMood - yesterdaysTotalMood;

            const renderDelta = (delta, unit = '', higherIsWorse = true) => {
                if (yesterdaysMetrics.length === 0) return `<span class="text-xs text-gray-500">Keine Vortag Daten</span>`;
                if (delta === 0) return `<span class="text-xs text-gray-500">(Keine Änderung)</span>`;
                
                const isWorse = higherIsWorse ? delta > 0 : delta < 0;
                const color = isWorse ? 'text-red-500' : 'text-green-500';
                const sign = delta > 0 ? '+' : '';
                
                return `<span class="text-xs ${color} font-semibold">(${sign}${delta}${unit})</span>`;
            };

            let summaryHtml = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div onclick="WellTrackApp.events.showPage('event')" class="bg-white p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-shadow"><p class="text-sm text-gray-600">Zeit Ereignisse</p><p class="text-2xl font-bold">${todaysTotalEvent} <span class="text-lg">min</span></p>${renderDelta(eventDelta, ' min', false)}</div>
                    <div onclick="WellTrackApp.events.showPage('mood')" class="bg-white p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-shadow"><p class="text-sm text-gray-600">Stimmung</p><p class="text-2xl font-bold">${todaysTotalMood}</p>${renderDelta(moodDelta, '', false)}</div>
                    <div onclick="WellTrackApp.events.showPage('pain')" class="bg-white p-4 rounded-lg text-center cursor-pointer hover:shadow-lg transition-shadow"><p class="text-sm text-gray-600">Schmerz</p><p class="text-2xl font-bold">${todaysTotalPain}</p>${renderDelta(painDelta, '', true)}</div>
                </div>
            `;

            if (summarizedToday.length === 0) {
                container.innerHTML = summaryHtml + `<p class="text-gray-500 text-center py-4">Noch keine Einträge für heute.</p>`;
                return;
            }

            let listHtml = '<h3 class="text-lg font-semibold mb-2 text-gray-800">Heutige Einträge:</h3><ul class="space-y-2">';
            summarizedToday.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).forEach(metric => {
                 listHtml += `<li class="text-sm text-gray-700">${this.components.todaysLogEntry(metric)}</li>`;
            });
            listHtml += '</ul>';

            container.innerHTML = summaryHtml + listHtml;
        },
        pagination(totalItems) {
            const paginationContainer = document.getElementById('log-pagination');
            if(!paginationContainer) return;
            const totalPages = Math.ceil(totalItems / WellTrackApp.config.ENTRIES_PER_PAGE);
            if (totalPages <= 1) { paginationContainer.innerHTML = ''; return; }
            paginationContainer.innerHTML = this.components.paginationControls(WellTrackApp.state.currentPage, totalPages);
        },
        manageEventList() {
            const container = document.getElementById('manage-event-list');
            if (!container) return;
            container.innerHTML = '';
            WellTrackApp.data.getEvents().forEach((event, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-100 p-3 rounded-lg';
                div.innerHTML = this.components.manageEventItem(event, index);
                container.appendChild(div);
            });
        },
        charts: {
            renderAll() {
                this.pain();
                this.event();
                this.mood();
            },
            pain() {
                const ctx = document.getElementById('painChart')?.getContext('2d');
                if (!ctx) return;
                const { dailyData, allLabels } = WellTrackApp.utils.getDailyChartData('pain_');
                
                const datasets = allLabels.map(partName => {
                    const dataPoints = dailyData.map(day => ({ x: day.timestamp, y: day.values[partName] || 0 }));
                    return {
                        label: partName,
                        data: dataPoints,
                        borderColor: WellTrackApp.utils.generateColorFromHash(partName),
                        backgroundColor: WellTrackApp.utils.generateColorFromHash(partName, 0.5),
                        fill: false,
                        tension: 0.1,
                    };
                });
                
                if (datasets.length > 0) {
                    const movingAverageData = WellTrackApp.utils.calculateMovingAverage(dailyData.map(d => ({x: d.timestamp, y: d.total})));
                    datasets.push({
                        label: 'Durchschnitt',
                        data: movingAverageData,
                        borderColor: 'rgba(239, 68, 68, 0.8)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        tension: 0.4
                    });
                }
                
                const yAxisOptions = { beginAtZero: true, stacked: true, title: { display: true, text: 'Schmerzintensität', ...WellTrackApp.config.CHART_FONT_OPTIONS }, ticks: { ...WellTrackApp.config.CHART_FONT_OPTIONS, maxTicksLimit: 8 } };
                
                if (WellTrackApp.state.charts.pain) { WellTrackApp.state.charts.pain.destroy(); }
                WellTrackApp.state.charts.pain = new Chart(ctx, { type: 'line', data: { datasets }, options: { plugins: { legend: { position: 'bottom', labels: {...WellTrackApp.config.CHART_FONT_OPTIONS} } }, scales: { x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'dd.MM' } }, grid: { display: false }, ticks: {...WellTrackApp.config.CHART_FONT_OPTIONS} }, y: yAxisOptions } } });
            },
            event() {
                const eventChartContainer = document.getElementById('chart-container-event');
                if (!eventChartContainer) return;
                eventChartContainer.innerHTML = ''; // Clear previous charts

                const allEvents = WellTrackApp.data.getEvents();
                const groupedBy = allEvents.reduce((acc, event) => {
                    const key = event.groupType ? `${event.groupType}-${event.unitType}` : `* -${event.unitType}`;
                    if(!acc[key]) acc[key] = [];
                    acc[key].push(event.activity);
                    return acc;
                }, {});

                Object.entries(groupedBy).forEach(([groupKey, activities]) => {
                    const [groupType, unitType] = groupKey.split('-');
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    eventChartContainer.appendChild(canvas);

                    const { dailyData } = WellTrackApp.utils.getDailyChartData('event_', d => activities.includes(d.labels.activity));
                    
                    let chartLabel = `${groupType === '*' ? 'Ohne Gruppe' : groupType} (${unitType})`;
                    if (activities.length === 1) {
                         const singleEvent = allEvents.find(e => e.activity === activities[0]);
                         if (singleEvent) chartLabel = singleEvent.name;
                    }
                    
                    const datasets = [{
                        label: chartLabel,
                        data: dailyData.map(d => ({x: d.timestamp, y: d.total, details: d.details})),
                        borderColor: WellTrackApp.utils.generateColorFromHash(groupKey),
                        backgroundColor: WellTrackApp.utils.generateColorFromHash(groupKey, 0.5),
                        fill: true,
                        tension: 0.1,
                    }];

                    if(datasets[0].data.length > 0) {
                        const movingAverageData = WellTrackApp.utils.calculateMovingAverage(datasets[0].data);
                        datasets.push({
                            label: `Durchschnitt`,
                            data: movingAverageData,
                            borderColor: 'rgba(239, 68, 68, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0.4
                        });
                    }
                    
                    if (WellTrackApp.state.charts[groupKey]) WellTrackApp.state.charts[groupKey].destroy();
                    WellTrackApp.state.charts[groupKey] = new Chart(ctx, { 
                        type: 'line', 
                        data: { datasets }, 
                        options: { 
                            plugins: { 
                                legend: { position: 'bottom', labels: {...WellTrackApp.config.CHART_FONT_OPTIONS} },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const rawData = context.raw;
                                            let label = context.dataset.label || '';
                                            if (label) { label += ': '; }
                                            label += rawData.y;

                                            const details = rawData.details;
                                            const timestamps = Object.values(details).flat();
                                            if (timestamps.length > 0) {
                                                const times = timestamps.map(ts => new Date(ts).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })).join(', ');
                                                return [label, `Zeiten: ${times}`];
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }, 
                            scales: { 
                                x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'dd.MM' } }, grid: { display: false }, ticks: {...WellTrackApp.config.CHART_FONT_OPTIONS} }, 
                                y: { title: { display: true, text: `Wert (${unitType || 'Anzahl'})`, ...WellTrackApp.config.CHART_FONT_OPTIONS }, ticks: {...WellTrackApp.config.CHART_FONT_OPTIONS, maxTicksLimit: 8 }, min: 0 } 
                            },
                        } 
                    });
                });
            },
            mood() {
                const ctx = document.getElementById('moodChart')?.getContext('2d');
                if (!ctx) return;

                const { dailyData, allLabels } = WellTrackApp.utils.getDailyChartData('mood_');
                
                const candleData = dailyData.map(day => {
                    const positiveSum = Object.entries(day.values).reduce((sum, [key, val]) => sum + (val > 0 ? val : 0), 0);
                    const negativeSum = Object.entries(day.values).reduce((sum, [key, val]) => sum + (val < 0 ? val : 0), 0);
                    return { x: day.timestamp, y: [negativeSum, positiveSum], details: day.values };
                });

                const datasets = [{
                    label: 'Stimmung (Negativ vs. Positiv)',
                    data: candleData,
                    backgroundColor: 'rgba(103, 80, 164, 0.5)',
                    borderColor: 'rgba(103, 80, 164, 1)',
                    borderWidth: 1,
                    borderSkipped: false,
                }];

                const movingAverageData = WellTrackApp.utils.calculateMovingAverage(dailyData.map(d => ({x: d.timestamp, y: d.total})));
                 datasets.push({
                    type: 'line',
                    label: 'Durchschnitt (Gesamt)',
                    data: movingAverageData,
                    borderColor: 'rgba(239, 68, 68, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    tension: 0.4
                });
                
                const yAxisOptions = {
                    title: { display: true, text: 'Kumulativer Stimmungswert', ...WellTrackApp.config.CHART_FONT_OPTIONS },
                    ticks: { ...WellTrackApp.config.CHART_FONT_OPTIONS, maxTicksLimit: 8 }
                };
                
                if (WellTrackApp.state.charts.mood) { WellTrackApp.state.charts.mood.destroy(); }
                WellTrackApp.state.charts.mood = new Chart(ctx, {
                    type: 'bar',
                    data: { datasets },
                    options: {
                        plugins: { 
                            legend: { position: 'bottom', labels: { ...WellTrackApp.config.CHART_FONT_OPTIONS } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const originalData = context.chart.data.datasets[0].data[context.dataIndex];
                                        let tooltipText = [`Gesamt: ${originalData.y[1] + originalData.y[0]} (Pos: ${originalData.y[1]}, Neg: ${originalData.y[0]})`, '---'];
                                        for(const [key, value] of Object.entries(originalData.details)) {
                                            tooltipText.push(`${key}: ${value}`);
                                        }
                                        return tooltipText;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'dd.MM' } }, grid: { display: false }, ticks: { ...WellTrackApp.config.CHART_FONT_OPTIONS } },
                            y: yAxisOptions
                        }
                    }
                });
            }
        },
        modal: {
            show(content) {
                document.getElementById('modal-content').innerHTML = content;
                document.getElementById('modal-container').classList.remove('hidden');
            },
            hide() {
                document.getElementById('modal-container').classList.add('hidden');
                document.getElementById('modal-content').innerHTML = '';
            },
            showPainSelector(part) {
                WellTrackApp.state.currentPainPart = part;
                const content = WellTrackApp.render.components.painModalContent(part.dataset.name);
                this.show(content);
            },
            showAlert(title, message) {
                const content = `<h3 class="text-xl font-medium mb-4">${title}</h3><p class="mb-6">${message}</p><div class="flex justify-end"><button onclick="WellTrackApp.render.modal.hide()" class="btn btn-primary">OK</button></div>`;
                this.show(content);
            },
            showConfirmation(title, message, onConfirm) {
                 const content = `<h3 class="text-xl font-medium mb-4">${title}</h3><p class="mb-6">${message}</p><div class="flex justify-end gap-4"><button onclick="WellTrackApp.render.modal.hide()" class="btn btn-tertiary">Abbrechen</button><button id="confirm-action-btn" class="btn btn-primary">Bestätigen</button></div>`;
                this.show(content);
                document.getElementById('confirm-action-btn').onclick = () => { onConfirm(); this.hide(); };
            }
        },
        components: {
            todaySection: () => {
                const today = new Date();
                const dateString = today.toLocaleDateString('de-DE', { day: 'numeric', month: 'long', year: 'numeric' });
                return `
                <div class="card">
                    <div class="mb-4">
                         <h2 class="text-2xl font-semibold text-gray-700">Heute (${dateString})</h2>
                    </div>
                    <div id="todays-log-container"></div>
                </div>
                `;
            },
            eventSection: () => {
                const events = WellTrackApp.data.getEvents();
                const hasNoGroup = events.some(e => !e.groupType);
                const groups = [...new Set(events.map(e => e.groupType).filter(g => g))].sort();
                if (hasNoGroup) { groups.push('*'); }

                // If no group is selected, default to the first one available
                if (WellTrackApp.state.activeEventGroup === null && groups.length > 0) {
                    WellTrackApp.state.activeEventGroup = groups[0];
                }
                
                let groupButtons = groups.map((group, index) => {
                    const groupName = group === '*' ? 'Ohne Gruppe' : group;
                    const firstClass = index === 0 ? 'rounded-l-full' : '';
                    const lastClass = index === groups.length - 1 ? 'rounded-r-full' : '';
                    const activeClass = WellTrackApp.state.activeEventGroup === group ? 'active' : '';

                    return `<button type="button" onclick="WellTrackApp.events.handleEventGroupToggle('${group}')" id="btn-event-group-${group}" class="view-toggle-btn px-4 py-2 text-sm font-medium bg-white border border-gray-200 hover:bg-gray-100 ${firstClass} ${lastClass} ${activeClass}">${groupName}</button>`
                }).join('');

                return `
                <div class="card">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Ereignisse</h2>
                        <div class="inline-flex rounded-full shadow-sm" role="group">
                            ${groupButtons}
                        </div>
                    </div>
                    <div id="todays-event-container" class="space-y-4"></div>
                </div>`;
            },
            moodSection: () => {
                const moodGroups = WellTrackApp.config.MOOD_GROUPS;
                const activeGroupKey = WellTrackApp.state.activeMoodGroup;
                const activeGroup = moodGroups[activeGroupKey];
                 let groupButtons = Object.keys(moodGroups).map(groupId => 
                    `<button type="button" onclick="WellTrackApp.events.handleMoodGroupToggle('${groupId}')" id="btn-mood-${groupId}" class="view-toggle-btn px-4 py-2 text-sm font-medium bg-white border border-gray-200 hover:bg-gray-100 ${activeGroupKey === groupId ? 'active' : ''} ${Object.keys(moodGroups).indexOf(groupId) === 0 ? 'rounded-l-full' : ''} ${Object.keys(moodGroups).indexOf(groupId) === Object.keys(moodGroups).length - 1 ? 'rounded-r-full' : ''}">${moodGroups[groupId].name}</button>`
                ).join('');

                return `
                <div class="card">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div class="flex items-center gap-2">
                            <h2 id="mood-section-title" class="text-xl md:text-2xl font-semibold text-gray-700">Stimmung</h2>
                            <span id="mood-last-entry-time" class="text-sm text-gray-500"></span>
                            <button id="new-entry-btn" onclick="WellTrackApp.events.finishAndStartNewEntry()" class="btn" disabled>
                                <span class="material-symbols-outlined">plus_one</span>
                            </button>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="inline-flex rounded-full shadow-sm" role="group">
                                ${groupButtons}
                            </div>
                        </div>
                    </div>
                    <div id="mood-container" class="space-y-8">${activeGroup.questions.map(q => WellTrackApp.render.components.moodSlider(q)).join('')}</div>
                </div>`;
            },
            painSection: () => `
                <div class="card">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <div class="flex items-center gap-2">
                            <h2 id="pain-section-title" class="text-xl md:text-2xl font-semibold text-gray-700">Rückseite</h2>
                            <span id="pain-last-entry-time" class="text-sm text-gray-500"></span>
                            <button id="new-entry-btn" onclick="WellTrackApp.events.finishAndStartNewEntry()" class="btn" disabled>
                                <span class="material-symbols-outlined">plus_one</span>
                            </button>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="inline-flex rounded-full shadow-sm" role="group">
                                <button type="button" onclick="WellTrackApp.events.handleViewToggle('front')" id="btn-view-front" class="view-toggle-btn px-4 py-2 text-sm font-medium bg-white border border-gray-200 rounded-l-full hover:bg-gray-100">Vorderseite</button>
                                <button type="button" onclick="WellTrackApp.events.handleViewToggle('back')" id="btn-view-back" class="view-toggle-btn px-4 py-2 text-sm font-medium bg-white border border-gray-200 rounded-r-full hover:bg-gray-100 active">Rückseite</button>
                            </div>
                             
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <svg id="pain-figure" viewBox="0 0 130 200" xmlns="http://www.w3.org/2000/svg">
                           <g id="body-front" transform="translate(5, 0)" class="hidden">
                                <circle id="head_front" data-name="Kopf" class="body-part" cx="60" cy="25" r="15"/>
                                <rect id="torso_chest_left" data-name="Brust (L)" class="body-part" x="40" y="40" width="15" height="30" rx="2"/>
                                <rect id="torso_chest_right" data-name="Brust (R)" class="body-part" x="65" y="40" width="15" height="30" rx="2"/>
                                <rect id="torso_abdomen_left" data-name="Bauch (L)" class="body-part" x="40" y="72" width="15" height="28" rx="2"/>
                                <rect id="torso_abdomen_right" data-name="Bauch (R)" class="body-part" x="65" y="72" width="15" height="28" rx="2"/>
                                <line x1="60" y1="40" x2="60" y2="100" stroke="#9ca3af" stroke-width="0.5"/>
                                <rect id="arm_left_front" data-name="Linker Arm" class="body-part" x="20" y="42" width="15" height="70" rx="5"/>
                                <rect id="hand_left_front" data-name="Hand (L)" class="body-part" x="17" y="112" width="21" height="15" rx="3"/>
                                <rect id="arm_right_front" data-name="Rechter Arm" class="body-part" x="85" y="42" width="15" height="70" rx="5"/>
                                <rect id="hand_right_front" data-name="Hand (R)" class="body-part" x="82" y="112" width="21" height="15" rx="3"/>
                                <rect id="leg_left_front" data-name="Linkes Bein" class="body-part" x="41" y="105" width="13" height="80" rx="5"/>
                                <rect id="foot_left_front" data-name="Fuß (L)" class="body-part" x="38" y="185" width="19" height="12" rx="3"/>
                                <rect id="leg_right_front" data-name="Rechtes Bein" class="body-part" x="66" y="105" width="13" height="80" rx="5"/>
                                <rect id="foot_right_front" data-name="Fuß (R)" class="body-part" x="63" y="185" width="19" height="12" rx="3"/>
                                <text x="60" y="28" class="svg-label">Kopf</text><text x="60" y="58" class="svg-label">Brust</text><text x="60" y="88" class="svg-label">Bauch</text>
                            </g>
                            <g id="body-back" transform="translate(5, 0)">
                                <circle id="head_back" data-name="Hinterkopf" class="body-part" cx="60" cy="25" r="15"/>
                                <rect id="back_cervical_left" data-name="HWS (L)" class="body-part" x="40" y="40" width="15" height="20" rx="2"/>
                                <rect id="back_cervical_right" data-name="HWS (R)" class="body-part" x="65" y="40" width="15" height="20" rx="2"/>
                                <rect id="back_thoracic_left" data-name="BWS (L)" class="body-part" x="40" y="62" width="15" height="20" rx="2"/>
                                <rect id="back_thoracic_right" data-name="BWS (R)" class="body-part" x="65" y="62" width="15" height="20" rx="2"/>
                                <rect id="back_lumbar_left" data-name="LWS (L)" class="body-part" x="40" y="84" width="15" height="16" rx="2"/>
                                <rect id="back_lumbar_right" data-name="LWS (R)" class="body-part" x="65" y="84" width="15" height="16" rx="2"/>
                                <line x1="60" y1="40" x2="60" y2="100" stroke="#9ca3af" stroke-width="0.5"/>
                                <rect id="arm_left_back" data-name="Linker Arm (h)" class="body-part" x="20" y="42" width="15" height="70" rx="5"/>
                                <rect id="hand_left_back" data-name="Hand (L,h)" class="body-part" x="17" y="112" width="21" height="15" rx="3"/>
                                <rect id="arm_right_back" data-name="Rechter Arm (h)" class="body-part" x="85" y="42" width="15" height="70" rx="5"/>
                                <rect id="hand_right_back" data-name="Hand (R,h)" class="body-part" x="82" y="112" width="21" height="15" rx="3"/>
                                <rect id="glute_left_back" data-name="Gesäß (L)" class="body-part" x="41" y="105" width="13" height="20" rx="3"/>
                                <rect id="glute_right_back" data-name="Gesäß (R)" class="body-part" x="66" y="105" width="13" height="20" rx="3"/>
                                <rect id="leg_left_back" data-name="Linkes Bein (h)" class="body-part" x="41" y="127" width="13" height="58" rx="5"/>
                                <rect id="foot_left_back" data-name="Fuß (L,h)" class="body-part" x="38" y="185" width="19" height="12" rx="3"/>
                                <rect id="leg_right_back" data-name="Rechtes Bein (h)" class="body-part" x="66" y="127" width="13" height="58" rx="5"/>
                                <rect id="foot_right_back" data-name="Fuß (R,h)" class="body-part" x="63" y="185" width="19" height="12" rx="3"/>
                                <text x="60" y="52" class="svg-label">HWS</text><text x="60" y="74" class="svg-label">BWS</text><text x="60" y="94" class="svg-label">LWS</text>
                            </g>
                        </svg>
                    </div>
                </div>`,
            historySection: () => {
                const activeTab = WellTrackApp.state.activeHistoryTab;
                return `
                <div class="card">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <div class="flex items-center gap-4">
                           <h2 id="log-title" class="text-2xl font-semibold text-gray-700">Verlauf</h2>
                            <select id="time-range-selector" onchange="WellTrackApp.events.handleTimeRangeChange(event)" class="border border-gray-300 rounded-full text-sm focus:ring-blue-500 focus:border-blue-500 block w-auto p-2.5">
                                <option value="7" ${WellTrackApp.state.timeRange === 7 ? 'selected' : ''}>Letzte 7 Tage</option>
                                <option value="30" ${WellTrackApp.state.timeRange === 30 ? 'selected' : ''}>Letzte 30 Tage</option>
                                <option value="180" ${WellTrackApp.state.timeRange === 180 ? 'selected' : ''}>Letzte 6 Monate</option>
                            </select>
                        </div>
                         <div id="history-tabs" class="history-tab-group inline-flex rounded-full shadow-sm" role="group">
                             <button onclick="WellTrackApp.events.handleHistoryTabClick('event')" class="history-tab view-toggle-btn px-4 py-2 text-sm font-medium bg-white border border-gray-200 rounded-l-full hover:bg-gray-100" data-tab="event">Ereignisse</button>
                            <button onclick="WellTrackApp.events.handleHistoryTabClick('mood')" class="history-tab view-toggle-btn px-4 py-2 text-sm font-medium bg-white border border-gray-200 hover:bg-gray-100" data-tab="mood">Stimmung</button>
                            <button onclick="WellTrackApp.events.handleHistoryTabClick('pain')" class="history-tab view-toggle-btn px-4 py-2 text-sm font-medium bg-white border border-gray-200 rounded-r-full hover:bg-gray-100" data-tab="pain">Schmerz</button>
                        </div>
                    </div>
                    <div id="chart-container-event" class="chart-container space-y-4"></div>
                    <div id="chart-container-mood" class="chart-container hidden"><canvas id="moodChart"></canvas></div>
                    <div id="chart-container-pain" class="chart-container hidden"><canvas id="painChart"></canvas></div>
                </div>`;
            },
            fullLogSection: () => `
                <div class="card"><h2 class="text-2xl font-semibold mb-4 text-gray-700">Protokoll</h2><div id="log-entries-container" class="space-y-4"></div><div id="log-pagination" class="mt-6 flex justify-between items-center"></div></div>`,
            settingsSection: () => {
                const reminderTime = localStorage.getItem('wellTrackReminderTime') || '';
                const perm = WellTrackApp.state.notificationPermission;
                return `
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Ereignisarten</h2>
                    <div id="manage-event-list" class="space-y-2 mb-4"></div>
                    <div id="edit-event-form-container"></div>
                    <div class="mt-4"><button id="add-new-event-btn" onclick="WellTrackApp.events.handleShowEventForm()" class="btn btn-primary w-full"><span class="material-symbols-outlined mr-2">add</span>Neue hinzufügen</button></div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Erinnerungen</h2>
                    <div id="reminder-section" class="space-y-4">
                         <p class="text-sm text-gray-600">Status: <span class="font-bold">${perm === 'granted' ? 'Erlaubt' : (perm === 'denied' ? 'Blockiert' : 'Nicht festgelegt')}</span></p>
                         ${perm === 'default' ? '<button onclick="WellTrackApp.events.requestNotificationPermission()" class="btn btn-secondary w-full">Erinnerungen aktivieren</button>' : ''}
                         ${perm === 'granted' ? `
                            <div>
                                <label for="reminder-time" class="block mb-1 text-sm font-medium text-gray-900">Tägliche Erinnerung um</label>
                                <input type="time" id="reminder-time" value="${reminderTime}" onchange="WellTrackApp.events.saveReminderTime(this.value)" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <button onclick="WellTrackApp.events.showTestNotification()" class="btn btn-tertiary w-full">Test-Benachrichtigung</button>
                         `: ''}
                         ${perm === 'denied' ? '<p class="text-sm text-red-600">Sie müssen die Berechtigung in den Browser-Einstellungen ändern, um Benachrichtigungen zu erhalten.</p>' : ''}
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Datenverwaltung</h2>
                    <div class="flex flex-col md:flex-row gap-4">
                        <label class="btn btn-secondary flex-1 cursor-pointer"><span class="material-symbols-outlined mr-2">upload</span><span>Daten importieren</span><input type="file" id="import-file" class="hidden" onchange="WellTrackApp.data.importData(event)"></label>
                        <button onclick="WellTrackApp.data.exportData()" class="btn btn-secondary flex-1"><span class="material-symbols-outlined mr-2">download</span> Daten exportieren</button>
                    </div>
                    <div class="border-t my-4 border-gray-300"></div>
                     <div class="flex flex-col md:flex-row gap-4">
                        <button onclick="WellTrackApp.events.handleGenerateRandomData()" class="btn btn-error flex-1"><span class="material-symbols-outlined mr-2">auto_fix_high</span> Zufallsdaten erzeugen</button>
                        <button onclick="WellTrackApp.events.handleDeleteAllData()" class="btn btn-error flex-1"><span class="material-symbols-outlined mr-2">delete_forever</span> Alle Daten löschen</button>
                    </div>
                </div>
                `
            },
            eventItemIncrement: (event, value) => `
                <span class="text-lg font-medium text-gray-800 flex-1 flex items-center gap-2">${event.name}</span>
                <div class="flex items-center gap-3">
                    <button onclick="WellTrackApp.events.handleEventIncrement('${event.activity}', -${event.increment})" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold h-10 w-10 rounded-full text-2xl">-</button>
                    <span id="value-${event.activity}" class="text-2xl font-semibold w-24 text-center">${value} ${event.unitType}</span>
                    <button onclick="WellTrackApp.events.handleEventIncrement('${event.activity}', ${event.increment})" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold h-10 w-10 rounded-full text-2xl">+</button>
                </div>`,
            eventItemTimestamp: (event, isDoneToday, entries) => {
                const lastEntry = entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                const lastTimestamp = lastEntry ? `(${new Date(lastEntry.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })})` : '';

                const buttonIcon = isDoneToday ? 'undo' : 'add';
                const buttonText = isDoneToday ? 'Rückgängig' : (event.unitType || 'Einnahme');
                const buttonAction = isDoneToday ? `WellTrackApp.events.handleUndoTimestamp('${event.activity}')` : `WellTrackApp.events.handleTimestampEvent('${event.activity}')`;
                const buttonClass = isDoneToday ? 'btn-tertiary' : 'btn-primary';

                return `
                <span class="text-lg font-medium text-gray-800 flex-1 flex items-center gap-2">
                    ${event.name}
                    <span class="text-sm text-gray-500 font-normal">${lastTimestamp}</span>
                </span>
                <div class="flex items-center gap-3">
                     <button onclick="${buttonAction}" class="btn ${buttonClass} min-w-[150px]">
                        <span class="material-symbols-outlined mr-2">${buttonIcon}</span>${buttonText}
                    </button>
                </div>`;
            },
            todaysLogEntry: (metric) => {
                const time = new Date(metric.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                if (metric.metric.startsWith('pain_')) {
                    const level = metric.value;
                    const props = WellTrackApp.config.PAIN_LEVELS[level] || {};
                    const color = props.color || '#ccc';
                    const textColor = (level > 2 && level < 6) ? 'white' : 'black';
                    return `(${time}) Schmerz in ${metric.labels.name}: <span class="font-bold px-2 py-1 rounded" style="background-color:${color}; color: ${textColor};">Stufe ${level}</span>`;
                }
                if (metric.metric.startsWith('event_')) {
                     if (metric.metric.endsWith('_timestamp')) {
                        return `(${time}) Ereignis ${metric.labels.name}: <span class="font-bold">Erfasst</span>`;
                     }
                    return `(${time}) Ereignis ${metric.labels.name}: <span class="font-bold">${metric.value} ${metric.labels.unitType || ''}</span>`;
                }
                if (metric.metric.startsWith('mood_')) {
                    const colorClass = metric.value > 0 ? 'text-green-600' : 'text-red-600';
                    return `(${time}) Stimmung ${metric.labels.name}: <span class="font-bold ${colorClass}">${metric.value > 0 ? '+' : ''}${metric.value}</span>`;
                }
                return `(${time}) Unbekannter Eintrag`;
            },
            logEntry: (date, metrics) => {
                let content = `<h3 class="font-bold mb-2">${date}</h3><div class="space-y-3">`;
                
                // Events
                const eventMetrics = metrics.filter(m => m.metric.startsWith('event_'));
                if (eventMetrics.length > 0) {
                    const eventDetails = eventMetrics.map(t => {
                        if (t.metric.endsWith('_timestamp')) {
                            const time = new Date(t.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                            return `${t.labels.name} (${time})`;
                        }
                        return `${t.labels.name} (${t.value} ${t.labels.unitType || ''})`;
                    }).join(', ');
                     content += `<div><strong>Ereignisse:</strong><div class="text-xs text-gray-600">${eventDetails}</div></div>`;
                }
                
                // Mood
                const moodMetrics = metrics.filter(m => m.metric.startsWith('mood_'));
                const totalMood = moodMetrics.reduce((sum, m) => sum + m.value, 0);
                if (moodMetrics.length > 0) {
                    let moodDetails = moodMetrics.map(m => {
                        const color = WellTrackApp.utils.generateColorFromHash(m.labels.name);
                        const valueColorClass = m.value > 0 ? 'text-green-600' : 'text-red-600';
                        return `<span class="inline-flex items-center gap-1 text-xs text-gray-600 mr-2">
                                    <span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                                    ${m.labels.name} (<span class="font-semibold ${valueColorClass}">${m.value > 0 ? '+' : ''}${m.value}</span>)
                                </span>`;
                    }).join('');
                    content += `<div><strong>Stimmung: ${totalMood}</strong><div class="mt-1 flex flex-wrap">${moodDetails}</div></div>`;
                }

                // Pain
                const painMetrics = metrics.filter(m => m.metric.startsWith('pain_'));
                const totalPain = painMetrics.reduce((sum, m) => sum + m.value, 0);
                if (painMetrics.length > 0) {
                     const painDetails = painMetrics.map(p => {
                        const props = WellTrackApp.config.PAIN_LEVELS[p.value] || {};
                        const color = props.color || '#ccc';
                        const textColor = (p.value > 2 && p.value < 6) ? 'white' : 'black';
                        return `${p.labels.name} (<span class="font-semibold px-1 rounded" style="background-color:${color}; color:${textColor};">${p.value}</span>)`;
                    }).join(', ');
                    content += `<div><strong>Schmerz: ${totalPain}</strong><div class="text-xs text-gray-600">${painDetails}</div></div>`;
                }

                return content + `</div>`;
            },
            paginationControls: (currentPage, totalPages) => `<button onclick="WellTrackApp.events.handleChangePage(-1)" class="btn btn-tertiary" ${currentPage === 1 ? 'disabled' : ''}>Zurück</button><span class="text-sm text-gray-700">Seite ${currentPage} von ${totalPages}</span><button onclick="WellTrackApp.events.handleChangePage(1)" class="btn btn-tertiary" ${currentPage === totalPages ? 'disabled' : ''}>Weiter</button>`,
            manageEventItem: (event, index) => {
                const scheduledDays = event.days && event.days.length > 0 ? event.days.map(d => WellTrackApp.config.DAY_NAMES[d]).join(', ') : 'Täglich';
                const incrementText = event.increment === 0 ? 'Timestamp' : `+${event.increment}`;
                const detailsText = `${incrementText} ${event.unitType || ''}`;
                return `
                    <div class="flex items-center gap-3 flex-grow">
                        <button onclick="WellTrackApp.events.handleShowEventForm(WellTrackApp.data.getEvents()[${index}])" class="text-blue-500 hover:text-blue-700">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                        <div>
                            <span>${event.name} <span class="text-xs text-gray-400">(${detailsText})</span></span>
                            <span class="text-xs text-gray-500 block">Gruppe: ${event.groupType || 'Keine'} | ${scheduledDays}</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button onclick="WellTrackApp.events.handleRemoveEvent(${index})" class="text-red-400 hover:text-red-600">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>`;
            },
            painModalContent: (partName) => {
                let buttons = '';
                for (const [level, props] of Object.entries(WellTrackApp.config.PAIN_LEVELS)) { buttons += `<button onclick="WellTrackApp.events.handleSetPainLevel(${level})" class="btn w-full text-lg font-bold py-4 px-4 rounded-xl" style="background-color:${props.color}; color: ${parseInt(level) > 2 && parseInt(level) < 6 ? 'white' : 'black'}">${props.short} (${props.label})</button>`; }
                return `<h3 class="text-2xl font-semibold mb-6 text-center">Schmerz in: ${partName}</h3><div class="grid grid-cols-1 gap-4">${buttons}</div><button onclick="WellTrackApp.render.modal.hide()" class="mt-8 text-gray-500 hover:text-gray-700 w-full">Abbrechen</button>`;
            },
            eventForm: (event = null) => {
                const isEditing = event !== null;
                const name = isEditing ? event.name : '';
                const activity = isEditing ? event.activity : '';
                const increment = isEditing ? event.increment : 1;
                const unitType = isEditing ? event.unitType : '';
                const groupType = isEditing ? event.groupType : '';

                let dayButtons = '';
                WellTrackApp.config.DAY_DISPLAY_ORDER.forEach(day => {
                    const isSelected = isEditing && event.days && event.days.includes(day.index);
                    dayButtons += `<button data-day-index="${day.index}" class="day-btn p-2 border rounded-md ${isSelected ? 'selected' : ''}">${day.name}</button>`;
                });

                return `
                <div class="p-4 border rounded-lg bg-white mt-4">
                    <h3 class="text-xl font-semibold mb-4">${isEditing ? 'Ereignisart bearbeiten' : 'Neue Ereignisart'}</h3>
                    <div class="space-y-4 text-left">
                        <div><label for="event-name" class="block mb-1 text-sm font-medium">Bezeichnung</label><input id="event-name" type="text" value="${name}" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="z.B. Tassen Kaffee"></div>
                        <div><label for="event-activity" class="block mb-1 text-sm font-medium">Aktivität-ID</label><input id="event-activity" type="text" value="${activity}" ${isEditing ? 'disabled' : ''} class="w-full p-2 border border-gray-300 rounded-lg ${isEditing ? 'bg-gray-100' : ''}" placeholder="z.B. kaffee_tassen"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="event-increment" class="block mb-1 text-sm font-medium">Inkrement (0=Timestamp)</label><input id="event-increment" type="number" value="${increment}" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="1"></div>
                            <div><label for="event-unit" class="block mb-1 text-sm font-medium">Einheit</label><input id="event-unit" type="text" value="${unitType}" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="min, x, etc."></div>
                        </div>
                         <div><label for="event-group" class="block mb-1 text-sm font-medium">Gruppe (optional)</label><input id="event-group" type="text" value="${groupType}" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="z.B. Medikamente"></div>
                        <div><label class="block mb-2 text-sm font-medium">Tage (optional)</label><div id="day-selector-container" class="grid grid-cols-7 gap-1 text-center" onclick="WellTrackApp.events.handleToggleDay(event)">${dayButtons}</div><p class="text-xs text-gray-500 mt-1">Wenn keine Tage gewählt sind, ist das Ereignis immer sichtbar.</p></div>
                    </div>
                    <div class="flex gap-4 mt-6">
                        <button onclick="WellTrackApp.events.handleHideEventForm()" class="btn btn-tertiary flex-1">Abbrechen</button>
                        <button onclick="WellTrackApp.events.handleSaveEvent()" class="btn btn-primary flex-1">Speichern</button>
                    </div>
                </div>`;
            },
            moodSlider: (question) => `
                <div>
                    <div class="flex justify-between items-center text-center mb-3">
                        <span class="w-1/3 text-sm text-gray-600 text-left font-medium">${question.negative}</span>
                        <label class="w-1/3 text-gray-800 font-semibold">${question.name}</label>
                        <span class="w-1/3 text-sm text-gray-600 text-right font-medium">${question.positive}</span>
                    </div>
                    <div class="mood-slider-wrapper" onclick="WellTrackApp.events.handleMoodRulerClick(event, '${question.id}')">
                        <div class="mood-slider-ruler"></div>
                        <div class="mood-slider-tick-container">
                            ${Array.from({length: 6}).map(() => `<div class="mood-slider-tick"></div>`).join('')}
                        </div>
                        <input type="range" min="0" max="5" step="1" value="2.5" class="mood-slider w-full is-default" id="mood-slider-${question.id}" oninput="this.classList.remove('is-default')" onchange="WellTrackApp.events.handleMoodChange('${question.id}')">
                        <div class="mood-slider-default-indicator">
                             <span class="material-symbols-outlined text-3xl" style="font-variation-settings: 'FILL' 1">star</span>
                        </div>
                    </div>
                </div>`
        }
    },

    // --- EVENT HANDLING ---
    events: {
        registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
        },
        checkDayChange() {
            const today = new Date().toISOString().split('T')[0];
            if (WellTrackApp.state.lastDataResetDay !== today) {
                WellTrackApp.state.lastDataResetDay = today;
                 if (WellTrackApp.state.activePage === 'mood' || WellTrackApp.state.activePage === 'pain') {
                    WellTrackApp.data.loadTodaysState();
                }
            }
        },
        showPage(pageName) {
            WellTrackApp.state.activePage = pageName;
            this.checkDayChange();
            
            document.querySelectorAll('#header-left .nav-btn, #main-nav .nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === `nav-${pageName}`);
            });

            switch(pageName) {
                case 'today': WellTrackApp.render.todayPage(); break;
                case 'event': 
                    WellTrackApp.render.eventPage();
                    break;
                case 'mood': WellTrackApp.render.moodPage(); break;
                case 'pain': WellTrackApp.render.painPage(); break;
                case 'settings': WellTrackApp.render.settingsPage(); break;
                case 'history': WellTrackApp.render.historyPage(); break;
                case 'log': WellTrackApp.render.fullLogPage(); break;
            }
        },
        initEventListeners() {
            const observer = new IntersectionObserver((entries) => {
                const btn = document.getElementById('scroll-to-top');
                if(!btn) return;
                if (entries[0].boundingClientRect.y < 0) { btn.classList.remove('opacity-0', 'translate-y-4'); } 
                else { btn.classList.add('opacity-0', 'translate-y-4'); }
            }, { threshold: 0.1 });
            observer.observe(document.querySelector('header'));

            // Listen to any input/change to automatically save data
            document.body.addEventListener('change', () => WellTrackApp.data.saveData());
            document.body.addEventListener('input', () => WellTrackApp.data.saveData());
        },
        handleBodyPartClick(event) { WellTrackApp.render.modal.showPainSelector(event.target); },
        handleSetPainLevel(level) {
            const part = WellTrackApp.state.currentPainPart; if (!part) return;
            
            let metrics = WellTrackApp.data.getMetrics();
            
            const newEntry = {
                metric: `pain_${part.id}_level`,
                timestamp: new Date().toISOString(),
                labels: { body_part: part.id, name: part.dataset.name }, 
                value: parseInt(level, 10)
            };

            if (level === 0) {
                 part.style.fill = WellTrackApp.config.DEFAULT_BODY_COLOR; 
                 delete part.dataset.level; 
                 // We don't save a "0" entry, absence of entry means 0 pain.
            } else { 
                part.style.fill = WellTrackApp.config.PAIN_LEVELS[level].color; 
                part.dataset.level = level; 
                metrics.push(newEntry);
            }
            
            WellTrackApp.data.saveMetrics(metrics);
            WellTrackApp.state.isPainEntryStarted = true;
            this.updateNewEntryButtonState();
            WellTrackApp.data.loadTodaysState(); // to update timestamp
            WellTrackApp.render.modal.hide();
        },
        handleEventIncrement(activity, increment) {
            const event = WellTrackApp.data.getEvents().find(t => t.activity === activity);
            if (!event) return;
            
            let metrics = WellTrackApp.data.getMetrics();
            let todaysEntries = metrics.filter(e => e.labels.activity === activity && WellTrackApp.utils.isToday(new Date(e.timestamp)));
            const currentTotal = todaysEntries.reduce((sum, e) => sum + e.value, 0);

            const newValue = Math.max(0, currentTotal + increment);

            metrics.push({ 
                metric: `event_${activity}_value`, 
                timestamp: new Date().toISOString(), 
                labels: { activity: event.activity, name: event.name, unitType: event.unitType, groupType: event.groupType || '' }, 
                value: increment // We log the increment itself, not the total
            });
            
            document.getElementById(`value-${activity}`).textContent = `${newValue} ${event.unitType}`;
            WellTrackApp.data.saveMetrics(metrics);
        },
        handleTimestampEvent(activity) {
             const event = WellTrackApp.data.getEvents().find(e => e.activity === activity);
            if (!event) return;
            let metrics = WellTrackApp.data.getMetrics();
            metrics.push({
                metric: `event_${activity}_timestamp`,
                timestamp: new Date().toISOString(),
                labels: { activity: event.activity, name: event.name, unitType: event.unitType, groupType: event.groupType || '' },
                value: 1 // Value is 1 to be countable
            });
            WellTrackApp.data.saveMetrics(metrics);
            WellTrackApp.render.eventListByGroup(WellTrackApp.state.activeEventGroup);
        },
        handleUndoTimestamp(activity) {
            let metrics = WellTrackApp.data.getMetrics();
            const todaysTimestamps = metrics
                .map((m, index) => ({...m, originalIndex: index}))
                .filter(m => m.labels.activity === activity && WellTrackApp.utils.isToday(new Date(m.timestamp)))
                .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (todaysTimestamps.length > 0) {
                metrics.splice(todaysTimestamps[0].originalIndex, 1);
                WellTrackApp.data.saveMetrics(metrics);
                WellTrackApp.render.eventListByGroup(WellTrackApp.state.activeEventGroup);
            }
        },
        handleChangePage(direction) {
            const totalItems = Object.keys(WellTrackApp.data.getMetrics().reduce((acc, metric) => { acc[new Date(metric.timestamp).toLocaleDateString('de-DE')] = true; return acc; }, {})).length;
            const totalPages = Math.ceil(totalItems / WellTrackApp.config.ENTRIES_PER_PAGE);
            const newPage = WellTrackApp.state.currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) { WellTrackApp.render.fullLogPage(newPage); }
        },
        handleViewToggle(view) {
            document.getElementById('pain-section-title').textContent = view === 'front' ? 'Vorderseite' : 'Rückseite';
            document.getElementById('body-front').classList.toggle('hidden', view !== 'front');
            document.getElementById('body-back').classList.toggle('hidden', view === 'front');
            document.getElementById('btn-view-front').classList.toggle('active', view === 'front');
            document.getElementById('btn-view-back').classList.toggle('active', view !== 'front');
        },
        handleTimeRangeChange(event) {
            WellTrackApp.state.timeRange = parseInt(event.target.value, 10);
            WellTrackApp.render.historyPage();
        },
        handleRemoveEvent(index) {
            const events = WellTrackApp.data.getEvents();
            const eventNameToDelete = events[index].name;
            WellTrackApp.render.modal.showConfirmation('Ereignis löschen', `Möchtest du das Ereignis "${eventNameToDelete}" wirklich entfernen?`, () => {
                events.splice(index, 1);
                WellTrackApp.data.saveEvents(events);
                WellTrackApp.render.settingsPage();
                if(['event'].includes(WellTrackApp.state.activePage)) WellTrackApp.render.eventPage();
            });
        },
        handleToggleDay(event) {
            const button = event.target.closest('.day-btn');
            if (button) {
                button.classList.toggle('selected');
            }
        },
        handleSaveEvent() {
            const name = document.getElementById('event-name').value.trim();
            const activity = WellTrackApp.utils.slugify(document.getElementById('event-activity').value.trim());
            const increment = parseInt(document.getElementById('event-increment').value, 10); // Can be 0
            const unitType = document.getElementById('event-unit').value.trim();
            const groupType = document.getElementById('event-group').value.trim();

            if (!name || !activity) {
                WellTrackApp.render.modal.showAlert('Fehler', 'Bezeichnung und Aktivität-ID sind erforderlich.');
                return;
            }
            
            const events = WellTrackApp.data.getEvents();
            const isEditing = !!WellTrackApp.state.currentEditingEvent;

            if (!isEditing && events.some(t => t.activity === activity)) {
                WellTrackApp.render.modal.showAlert('Fehler', 'Diese Aktivität-ID wird bereits verwendet.');
                return;
            }

            const selectedDays = Array.from(document.querySelectorAll('#day-selector-container .day-btn.selected'))
                .map(btn => parseInt(btn.dataset.dayIndex, 10));

            const newEventData = { name, activity, days: selectedDays, increment, unitType, groupType };

            if (isEditing) {
                const index = events.findIndex(t => t.activity === WellTrackApp.state.currentEditingEvent.activity);
                if (index > -1) { events[index] = newEventData; }
            } else {
                events.push(newEventData);
            }

            WellTrackApp.data.saveEvents(events);
            this.handleHideEventForm();
            WellTrackApp.render.manageEventList();
            if(WellTrackApp.state.activePage === 'event') WellTrackApp.render.eventPage();
        },
        handleShowEventForm(event = null) {
            WellTrackApp.state.currentEditingEvent = event;
            document.getElementById('edit-event-form-container').innerHTML = WellTrackApp.render.components.eventForm(event);
            document.getElementById('add-new-event-btn').classList.add('hidden');
        },
        handleHideEventForm() {
            WellTrackApp.state.currentEditingEvent = null;
            document.getElementById('edit-event-form-container').innerHTML = '';
            document.getElementById('add-new-event-btn').classList.remove('hidden');
        },
        handleMoodRulerClick(event, moodId) {
            if (event.target.type === 'range') return; 
            const slider = document.getElementById(`mood-slider-${moodId}`);
            const rect = event.currentTarget.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const width = rect.width;
            
            const clickPercentage = clickX / width;
            const step = Math.round(clickPercentage * 5);

            slider.value = step;
            slider.classList.remove('is-default');
            
            const changeEvent = new Event('change');
            slider.dispatchEvent(changeEvent);
        },
        handleMoodChange(moodId) {
            const slider = document.getElementById(`mood-slider-${moodId}`);
            if (!slider) return;

            const sliderValue = parseInt(slider.value, 10);
            const value = WellTrackApp.config.MOOD_VALUE_MAP[sliderValue];
            
            let metrics = WellTrackApp.data.getMetrics();
            
            let question;
            for (const groupKey in WellTrackApp.config.MOOD_GROUPS) {
                const found = WellTrackApp.config.MOOD_GROUPS[groupKey].questions.find(q => q.id === moodId);
                if (found) { question = found; break; }
            }
            if(!question) return;

            metrics.push({
                metric: `mood_${moodId}_level`,
                timestamp: new Date().toISOString(),
                labels: { mood_id: moodId, name: question.name },
                value: value
            });
            
            WellTrackApp.data.saveMetrics(metrics);
            WellTrackApp.state.isMoodEntryStarted = true;
            this.updateNewEntryButtonState();
            WellTrackApp.data.loadTodaysState(); // to update timestamp
        },
        handleMoodGroupToggle(groupId) {
            WellTrackApp.state.activeMoodGroup = groupId;
            WellTrackApp.render.moodPage();
        },
        handleEventGroupToggle(groupType) {
            WellTrackApp.state.activeEventGroup = groupType;
            WellTrackApp.render.eventPage();
        },
        handleHistoryTabClick(tabName, shouldAnimate = true) {
            WellTrackApp.state.activeHistoryTab = tabName;
            
            document.querySelectorAll('.history-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            document.querySelectorAll('.chart-container').forEach(container => {
                container.classList.toggle('hidden', container.id !== `chart-container-${tabName}`);
            });
        },
        updateNewEntryButtonState() {
            const btn = document.getElementById('new-entry-btn');
            if (btn) {
                let isEnabled = false;
                if (WellTrackApp.state.activePage === 'mood') {
                    isEnabled = WellTrackApp.state.isMoodEntryStarted;
                } else if (WellTrackApp.state.activePage === 'pain') {
                    isEnabled = WellTrackApp.state.isPainEntryStarted;
                }
                btn.disabled = !isEnabled;
                btn.classList.toggle('btn-warning', isEnabled);
            }
        },
        finishAndStartNewEntry() {
            if (WellTrackApp.state.activePage === 'mood') {
                WellTrackApp.state.isMoodEntryStarted = false;
                document.querySelectorAll('.mood-slider').forEach(slider => {
                    slider.value = 2.5;
                    slider.classList.add('is-default');
                });
                document.getElementById('mood-last-entry-time').textContent = '';
                this.updateNewEntryButtonState();
            } else if (WellTrackApp.state.activePage === 'pain') {
                WellTrackApp.state.isPainEntryStarted = false;
                document.querySelectorAll('.body-part').forEach(part => {
                    part.style.fill = WellTrackApp.config.DEFAULT_BODY_COLOR;
                    delete part.dataset.level;
                });
                document.getElementById('pain-last-entry-time').textContent = '';
                this.updateNewEntryButtonState();
            }
        },
        async requestNotificationPermission() {
            const permission = await Notification.requestPermission();
            WellTrackApp.state.notificationPermission = permission;
            WellTrackApp.render.settingsPage(); // Re-render page to show new state
        },
        saveReminderTime(time) {
            if (time) {
                localStorage.setItem('wellTrackReminderTime', time);
            } else {
                localStorage.removeItem('wellTrackReminderTime');
            }
            WellTrackApp.data.saveData(); // Persist settings
        },
        showTestNotification() {
            if (WellTrackApp.state.notificationPermission === 'granted') {
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg) {
                        reg.showNotification('WellTrack Erinnerung', {
                            body: 'Zeit für deinen heutigen Tagebucheintrag!',
                            icon: 'icon-192.png'
                        });
                    } else {
                       WellTrackApp.render.modal.showAlert('Fehler', 'Service Worker nicht gefunden. Die Benachrichtigung kann nicht gesendet werden.')
                    }
                });
            } else {
                 WellTrackApp.render.modal.showAlert('Fehler', 'Die Berechtigung für Benachrichtigungen wurde nicht erteilt.')
            }
        },
        handleDeleteAllData() {
            WellTrackApp.render.modal.showConfirmation(
                'Alle Daten löschen',
                'Bist du sicher, dass du alle deine Einträge und Einstellungen unwiderruflich löschen möchtest? Diese Aktion kann nicht rückgängig gemacht werden.',
                () => {
                    localStorage.removeItem('wellTrackMetrics');
                    localStorage.removeItem('wellTrackEvents');
                    localStorage.removeItem('wellTrackReminderTime');
                    localStorage.removeItem('wellTrackExportableData');
                    location.reload();
                }
            );
        },
        handleGenerateRandomData() {
            WellTrackApp.render.modal.showConfirmation(
                'Zufallsdaten erzeugen',
                'Dadurch werden alle deine aktuellen Daten überschrieben. Möchtest du fortfahren und 180 Tage an Zufallsdaten erzeugen?',
                () => {
                    const randomMetrics = WellTrackApp.utils.generateRandomData();
                    WellTrackApp.data.saveMetrics(randomMetrics);
                    location.reload();
                }
            );
        },
    },

    // --- UTILITIES ---
    utils: {
        isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        },
        isToday(date) {
            return this.isSameDay(date, new Date());
        },
        scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); },
        slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '_')       // Replace spaces with _
                .replace(/[^\w_]+/g, '')    // Remove all non-word chars except _
                .replace(/__+/g, '_')       // Replace multiple _ with single _
                .replace(/^_+/, '')         // Trim _ from start of text
                .replace(/_+$/, '');        // Trim _ from end of text
        },
        simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = (hash << 5) - hash + char; hash |= 0; }
            return Math.abs(hash);
        },
        generateColorFromHash(str, opacity = 1) {
            const hash = this.simpleHash(str);
            const r = (hash & 0xFF0000) >> 16; const g = (hash & 0x00FF00) >> 8; const b = hash & 0x0000FF;
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        },
        summarizeMetrics(metrics) {
            const summarized = {};
            metrics.forEach(metric => {
                if (metric.metric.startsWith('event_') && !metric.metric.endsWith('_timestamp')) {
                    const key = `event-${metric.labels.activity}`;
                    if (!summarized[key]) {
                        summarized[key] = { ...metric, value: 0 };
                    }
                    summarized[key].value += metric.value;
                    if (metric.timestamp > summarized[key].timestamp) {
                        summarized[key].timestamp = metric.timestamp;
                    }
                } else {
                    summarized[metric.timestamp + metric.metric] = metric;
                }
            });
            return Object.values(summarized);
        },
        summarizeMetricsForExport(metrics) {
            const groupedByDay = {};
            metrics.forEach(m => {
                const day = m.timestamp.split('T')[0];
                if (!groupedByDay[day]) groupedByDay[day] = [];
                groupedByDay[day].push(m);
            });

            const finalMetrics = [];
            for (const day in groupedByDay) {
                finalMetrics.push(...this.summarizeMetrics(groupedByDay[day]));
            }
            return finalMetrics;
        },
        getDailyChartData(metricPrefix, filterFunc = () => true) {
            const data = WellTrackApp.data.getMetrics();
            const timeRangeDays = WellTrackApp.state.timeRange || 7;
            const startDate = new Date(); startDate.setHours(0, 0, 0, 0); startDate.setDate(startDate.getDate() - (timeRangeDays - 1));
            
            const filteredData = data.filter(entry => 
                entry.metric.startsWith(metricPrefix) && 
                new Date(entry.timestamp) >= startDate &&
                filterFunc(entry)
            );

            const dailyTotals = filteredData.reduce((acc, entry) => {
                const dayKey = new Date(entry.timestamp).setHours(0, 0, 0, 0);
                if (!acc[dayKey]) acc[dayKey] = { total: 0, values: {}, details: {} };
                
                const labelName = entry.labels.name;
                if (!acc[dayKey].values[labelName]) {
                    acc[dayKey].values[labelName] = 0;
                    acc[dayKey].details[labelName] = [];
                }
                
                const valueToAdd = entry.metric.endsWith('_timestamp') ? 1 : entry.value;
                acc[dayKey].values[labelName] += valueToAdd;
                acc[dayKey].total += valueToAdd;

                if (entry.metric.endsWith('_timestamp')) {
                    acc[dayKey].details[labelName].push(entry.timestamp);
                }

                return acc;
            }, {});

            const allLabels = [...new Set(filteredData.map(p => p.labels.name))];
            
            const dailyData = Object.entries(dailyTotals).map(([timestamp, data]) => ({
                timestamp: parseInt(timestamp),
                total: data.total,
                values: data.values,
                details: data.details
            })).sort((a,b) => a.timestamp - b.timestamp);

            return { dailyData, allLabels };
        },
        calculateMovingAverage(data) {
            const timeRange = WellTrackApp.state.timeRange;
            let windowSize = 3;
            if (timeRange === 30) windowSize = 7;
            if (timeRange === 180) windowSize = 28;
            
            if (!data || data.length < windowSize) return [];

            const movingAverage = [];
            for (let i = 0; i < data.length; i++) {
                if (i < windowSize - 1) {
                    movingAverage.push({x: data[i].x, y: null}); // Not enough data points
                } else {
                    let sum = 0;
                    for (let j = 0; j < windowSize; j++) {
                        sum += data[i - j].y;
                    }
                    movingAverage.push({x: data[i].x, y: sum / windowSize});
                }
            }
            return movingAverage;
        },
        generateRandomData() {
            const metrics = [];
            const today = new Date();
            today.setHours(12, 0, 0, 0); // Normalize time to avoid timezone issues

            const allBodyParts = [
                {id: 'head_front', name: 'Kopf'}, {id: 'torso_chest_left', name: 'Brust (L)'}, {id: 'torso_chest_right', name: 'Brust (R)'},
                {id: 'torso_abdomen_left', name: 'Bauch (L)'}, {id: 'torso_abdomen_right', name: 'Bauch (R)'}, {id: 'arm_left_front', name: 'Linker Arm'},
                {id: 'hand_left_front', name: 'Hand (L)'}, {id: 'arm_right_front', name: 'Rechter Arm'}, {id: 'hand_right_front', name: 'Hand (R)'},
                {id: 'leg_left_front', name: 'Linkes Bein'}, {id: 'foot_left_front', name: 'Fuß (L)'}, {id: 'leg_right_front', name: 'Rechtes Bein'},
                {id: 'foot_right_front', name: 'Fuß (R)'}, {id: 'head_back', name: 'Hinterkopf'}, {id: 'back_cervical_left', name: 'HWS (L)'},
                {id: 'back_cervical_right', name: 'HWS (R)'}, {id: 'back_thoracic_left', name: 'BWS (L)'}, {id: 'back_thoracic_right', name: 'BWS (R)'},
                {id: 'back_lumbar_left', name: 'LWS (L)'}, {id: 'back_lumbar_right', name: 'LWS (R)'}, {id: 'arm_left_back', name: 'Linker Arm (h)'},
                {id: 'hand_left_back', name: 'Hand (L,h)'}, {id: 'arm_right_back', name: 'Rechter Arm (h)'}, {id: 'hand_right_back', name: 'Hand (R,h)'},
                {id: 'glute_left_back', name: 'Gesäß (L)'}, {id: 'glute_right_back', name: 'Gesäß (R)'}, {id: 'leg_left_back', name: 'Linkes Bein (h)'},
                {id: 'foot_left_back', name: 'Fuß (L,h)'}, {id: 'leg_right_back', name: 'Rechtes Bein (h)'}, {id: 'foot_right_back', name: 'Fuß (R,h)'}
            ];
            const allMoodQuestions = Object.values(WellTrackApp.config.MOOD_GROUPS).flatMap(g => g.questions);
            const eventConfig = WellTrackApp.data.getEvents().reduce((acc, event) => {
                acc[event.activity] = event;
                return acc;
            }, {});

            for (let i = 179; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dayOfWeek = date.getDay(); 

                const setTimestamp = (hour, minute) => {
                    const d = new Date(date);
                    d.setHours(hour, minute, Math.floor(Math.random() * 60));
                    return d.toISOString();
                }

                // --- EVENTS ---
                if (eventConfig.walking && Math.random() < 0.9) {
                    const randomValue = (Math.random() + Math.random()) / 2 * 1.3; // Skew towards 60
                    const duration = Math.round(Math.min(90, randomValue * 90));
                    if (duration > 0) {
                        metrics.push({ metric: `event_walking_value`, timestamp: setTimestamp(18, 30), labels: { ...eventConfig.walking }, value: duration });
                    }
                }
                
                if (eventConfig.back_exercises && [1,2,4,5].includes(dayOfWeek)) {
                    metrics.push({ metric: `event_back_exercises_value`, timestamp: setTimestamp(8, 0), labels: { ...eventConfig.back_exercises }, value: 15 });
                }
                
                if(eventConfig.coffee_cups) {
                    const coffeeCount = Math.floor(Math.random() * 3) + 2; // 2 to 4
                    for(let c = 0; c < coffeeCount; c++) {
                        metrics.push({ metric: `event_coffee_cups_value`, timestamp: setTimestamp(9 + c * 2, 15), labels: { ...eventConfig.coffee_cups }, value: 1 });
                    }
                }

                if(eventConfig.ibuprofen_400 && Math.random() < 5/7) {
                    metrics.push({ metric: `event_ibuprofen_400_timestamp`, timestamp: setTimestamp(10, 0), labels: { ...eventConfig.ibuprofen_400 }, value: 1 });
                    if(dayOfWeek === 3) { // Wednesday double dose
                        metrics.push({ metric: `event_ibuprofen_400_timestamp`, timestamp: setTimestamp(16, 0), labels: { ...eventConfig.ibuprofen_400 }, value: 1 });
                    }
                }

                // --- MOOD ---
                const moodValues = [];
                for(let j=0; j<8; j++) moodValues.push(Math.random() > 0.5 ? 1 : -1);
                for(let j=0; j<3; j++) moodValues.push(Math.random() > 0.5 ? 2 : -2);
                if (i % 14 === 0) moodValues.push(Math.random() > 0.5 ? 3 : -3);

                const shuffledQuestions = [...allMoodQuestions].sort(() => 0.5 - Math.random());
                moodValues.forEach((val, index) => {
                    if(shuffledQuestions[index]) {
                        metrics.push({ metric: `mood_${shuffledQuestions[index].id}_level`, timestamp: setTimestamp(20, 0), labels: { mood_id: shuffledQuestions[index].id, name: shuffledQuestions[index].name }, value: val });
                    }
                });
                
                // --- PAIN ---
                const painChance = Math.random();
                const shuffledBodyParts = [...allBodyParts].sort(() => 0.5 - Math.random());
                if(painChance < 0.25) { // 1/4: 3x level 2
                    for(let p=0; p<3; p++) {
                        if(shuffledBodyParts[p]) {
                            metrics.push({ metric: `pain_${shuffledBodyParts[p].id}_level`, timestamp: setTimestamp(14, 0), labels: { body_part: shuffledBodyParts[p].id, name: shuffledBodyParts[p].name }, value: 2 });
                        }
                    }
                } else if (painChance < 0.5) { // 1/4: 1x level 1
                    if(shuffledBodyParts[0]) {
                        metrics.push({ metric: `pain_${shuffledBodyParts[0].id}_level`, timestamp: setTimestamp(14, 0), labels: { body_part: shuffledBodyParts[0].id, name: shuffledBodyParts[0].name }, value: 1 });
                    }
                } else if (painChance < 1) { // 2/4: 2x level 1
                     for(let p=0; p<2; p++) {
                        if(shuffledBodyParts[p]) {
                            metrics.push({ metric: `pain_${shuffledBodyParts[p].id}_level`, timestamp: setTimestamp(14, 0), labels: { body_part: shuffledBodyParts[p].id, name: shuffledBodyParts[p].name }, value: 1 });
                        }
                    }
                }
            }
            
            return metrics;
        },
    }
};

WellTrackApp.init();

</script>
</body>
</html>


